<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>搜狐微博</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0"/>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">

<script type="text/javascript" src="js/iscroll.js"></script>
<script type="text/javascript">
var myScroll,
	pullDownEl, pullDownOffset,
	pullUpEl, pullUpOffset,
	generatedCount = 0;

function pullDownAction () {
	setTimeout(function () {	// <-- Simulate network congestion, remove setTimeout from production!
		var el, li, i;
		el = document.getElementById('thelist');

		for (i=0; i<10; i++) {
			li = document.createElement('li');
			li.innerHTML = 'Generated row ' + (++generatedCount) + '';
			el.insertBefore(li, el.childNodes[0]);
		}
		
		myScroll.refresh();		// Remember to refresh when contents are loaded (ie: on ajax completion)
	}, 1000);	// <-- Simulate network congestion, remove setTimeout from production!
}

function pullUpAction () {
	setTimeout(function () {	// <-- Simulate network congestion, remove setTimeout from production!
		var el, li, i;
		el = document.getElementById('thelist');

		for (i=0; i<10; i++) {
			li = document.createElement('li');
			li.innerHTML = 'Generated row ' + (++generatedCount) + '';
			el.appendChild(li, el.childNodes[0]);
		}
		
		myScroll.refresh();		// Remember to refresh when contents are loaded (ie: on ajax completion)
	}, 1000);	// <-- Simulate network congestion, remove setTimeout from production!
}

function loaded() {
	pullDownEl = document.getElementById('pullDown');
	pullDownOffset = pullDownEl.offsetHeight;
	pullUpEl = document.getElementById('pullUp');	
	pullUpOffset = pullUpEl.offsetHeight;
	
	myScroll = new iScroll('wrapper', {
		useTransition: true,
		checkDOMChanges: true,
		topOffset: pullDownOffset,
		onRefresh: function () {
			if (pullDownEl.className.match('loading')) {
				pullDownEl.className = '';
				pullDownEl.querySelector('.pullDownLabel').innerHTML = 'Pull down to refresh...';
			} else if (pullUpEl.className.match('loading')) {
				pullUpEl.className = '';
				pullUpEl.querySelector('.pullUpLabel').innerHTML = 'Pull up to load more...';
			}
		},
		onScrollMove: function () {
			if (this.y > 5 && !pullDownEl.className.match('flip')) {
				pullDownEl.className = 'flip';
				pullDownEl.querySelector('.pullDownLabel').innerHTML = 'Release to refresh...';
				this.minScrollY = 0;
			} else if (this.y < 5 && pullDownEl.className.match('flip')) {
				pullDownEl.className = '';
				pullDownEl.querySelector('.pullDownLabel').innerHTML = 'Pull down to refresh...';
				this.minScrollY = -pullDownOffset;
			} else if (this.y < (this.maxScrollY - 5 ) && !pullUpEl.className.match('flip')) {
				pullUpEl.className = 'flip';
				pullUpEl.querySelector('.pullUpLabel').innerHTML = 'Release to refresh...';
				this.maxScrollY = this.maxScrollY;
			} else if (this.y > (this.maxScrollY + 5 ) && pullUpEl.className.match('flip')) {
				pullUpEl.className = '';
				pullUpEl.querySelector('.pullUpLabel').innerHTML = 'Pull up to load more...';
				this.maxScrollY = pullUpOffset;
			}
		},
		onScrollEnd: function () {
			if (pullDownEl.className.match('flip')) {
				pullDownEl.className = 'loading';
				pullDownEl.querySelector('.pullDownLabel').innerHTML = 'Loading...';				
				pullDownAction();	// Execute custom function (ajax call?)
			} else if (pullUpEl.className.match('flip')) {
				pullUpEl.className = 'loading';
				pullUpEl.querySelector('.pullUpLabel').innerHTML = 'Loading...';				
				pullUpAction();	// Execute custom function (ajax call?)
			}
		}
	});
	
}

document.addEventListener('touchmove', function (e) { e.preventDefault(); }, false);

document.addEventListener('DOMContentLoaded', function () { setTimeout(loaded, 500); }, false);
</script>

<style type="text/css" media="all">

/**
 *
 * Pull down styles
 *
 */
#pullDown, #pullUp {
	background:#fff;
	height:40px;
	line-height:40px;
	padding:5px 10px;
	border-bottom:1px solid #ccc;
	font-weight:bold;
	font-size:14px;
	color:#888;
}
#pullDown .pullDownIcon, #pullUp .pullUpIcon  {
	display:block; float:left;
	width:40px; height:40px;
	background:url(i/pull-icon@2x.png) 0 0 no-repeat;
	-webkit-background-size:40px 80px; background-size:40px 80px;
	-webkit-transition-property:-webkit-transform;
	-webkit-transition-duration:250ms;	
}
#pullDown .pullDownIcon {
	-webkit-transform:rotate(0deg) translateZ(0);
}
#pullUp .pullUpIcon  {
	-webkit-transform:rotate(-180deg) translateZ(0);
}

#pullDown.flip .pullDownIcon {
	-webkit-transform:rotate(-180deg) translateZ(0);
}

#pullUp.flip .pullUpIcon {
	-webkit-transform:rotate(0deg) translateZ(0);
}

#pullDown.loading .pullDownIcon, #pullUp.loading .pullUpIcon {
	background-position:0 100%;
	-webkit-transform:rotate(0deg) translateZ(0);
	-webkit-transition-duration:0ms;

	-webkit-animation-name:loading;
	-webkit-animation-duration:2s;
	-webkit-animation-iteration-count:infinite;
	-webkit-animation-timing-function:linear;
}

@-webkit-keyframes loading {
	from { -webkit-transform:rotate(0deg) translateZ(0); }
	to { -webkit-transform:rotate(360deg) translateZ(0); }
}

</style>

<script>
function getTheBox(t) {
	if(/box/.test(t.className)) return t;
	return getTheBox(t.parentNode);
}
function getNextBox(b) {
	var bArr = document.querySelectorAll('.box');
	if(bArr[0] == b) return bArr[1];
	if(bArr[1] == b) return bArr[0];
}
function setBoxClassName(b, s) {
	b.className = 'box ' + s;
}

/*
function roolLeftRun(cur, right) {
	setBoxClassName(cur, '');
	setBoxClassName(right, '_current');
}
function roolLeft(t) {
	var cur = getTheBox(t);
	var right = getNextBox(cur);
	//ready
	setBoxClassName(right, '_right _silence');
	//move
	setTimeout(function(){
		roolLeftRun(cur, right);
	}, 0);
}

function roolRightRun(cur, left) {
	setBoxClassName(cur, '_right');
	setBoxClassName(left, '_current');
}
function roolRightRun2(cur, left) {
	setBoxClassName(cur, '_silence');
	setTimeout(function(){
		roolRightRun3(cur, left);
	}, 0);
}
function roolRightRun3(cur, left) {
	setBoxClassName(cur, '');
}
function roolRight(t) {
	var cur = getTheBox(t);
	var left = getNextBox(cur);
	//ready
	setBoxClassName(left, '_left _silence');
	//move
	setTimeout(function(){
		roolRightRun(cur, left);
	}, 0);
	setTimeout(function(){
		roolRightRun2(cur, left);
	}, 400);
}
*/

function transitionEnd(evt) {
    var elem = this;
	evt.preventDefault();
	elem.removeEventListener("webkitTransitionEnd", transitionEnd, false);
	if (elem.moving) {
	    elem.moving = false;
		elem.callback();
		clearTimeout(elem.timeout);
	} else {
	    return;
	}
}

function addClassAnimate(elem, className, callback, delay) {
    elem.removeEventListener("webkitTransitionEnd", transitionEnd, false);
	elem.addEventListener("webkitTransitionEnd", transitionEnd, false);
	elem.callback = callback;
	elem.moving = true;
	elem.timeout = setTimeout(function() {
	    if (elem.moving) {
		    elem.moving = false;
			elem.callback();
		}
	}, delay != 0 ? delay : 0);
	elem.className = ("box " + className);
}

function roolLeft(t) {
	var cur = getTheBox(t);
	var right = getNextBox(cur);

	addClassAnimate(right, "_right _silence", function() {
		addClassAnimate(right, "_current", function() {});
		addClassAnimate(cur, "", function() {});
	});
}

function roolRight(t) {
	var cur = getTheBox(t);
	var left = getNextBox(cur);

	addClassAnimate(left, "_left _silence", function() {
		addClassAnimate(left, "_current", function() {});
		addClassAnimate(cur, "_right", function() {
			addClassAnimate(cur, "_silence", function() {
				addClassAnimate(cur, "", function() {});
			});
		}, 400);
	});
}

function seeTop(t) {
	var cur = getTheBox(t);
	var top = getNextBox(cur);

	addClassAnimate(top, "_top _silence", function() {
		addClassAnimate(top, "_middle", function() {});
	});
}
function hideTop(t) {
	var top = getTheBox(t);

	addClassAnimate(top, "_top", function() {
		addClassAnimate(top, "_silence", function() {
			addClassAnimate(top, "", function() {});
		});
	}, 400);
}

function seeBottom(t) {
	var cur = getTheBox(t);
	var bottom = getNextBox(cur);

	addClassAnimate(bottom, "_bottom _silence", function() {
		addClassAnimate(bottom, "_middle", function() {});
	});
}
function hideBottom(t) {
	var bottom = getTheBox(t);

	addClassAnimate(bottom, "_bottom", function() {
		addClassAnimate(bottom, "_silence", function() {
			addClassAnimate(bottom, "", function() {});
		});
	}, 400);
}



</script>


<style>
html,body,ul,li{padding:0;margin:0;overflow:hidden;-webkit-text-size-adjust:none;}

/* layout */
.gWrap{display:-webkit-box;-webkit-box-orient:vertical;}
.oWrap{-webkit-box-flex:1;	position:relative;}
.box{display:-webkit-box;-webkit-box-orient:vertical;}
.mWrap{position:relative!important;-webkit-box-flex:1;}
.iWrap{position:static!important;}

/* size */
.gWrap{position:absolute;width:100%;top:0;bottom:0;}
.box{position:absolute;width:100%;top:0;bottom:0;}

/* animition */
.gHeader,.oHeader,.gFooter,.oFooter{line-height:18px;height:36px;overflow:hidden;-webkit-transition:height .2s;}
/*.gHeader[style*="height"]{overflow:hidden;-webkit-transition:height .2s;}*/

.box{-webkit-transition:-webkit-transform .4s;-webkit-transform:translate3D(-100%, 0, 0);}
._silence{-webkit-transition:none;}

._left{-webkit-transform:translate3D(-100%, 0, 0);}
._current{-webkit-transform:translate3D(0, 0, 0);}
._right{-webkit-transform:translate3D(100%, 0, 0);}

._top{-webkit-transform:translate3D(0, -100%, 0);z-index:2;}
._middle{-webkit-transform:translate3D(0, 0, 0);z-index:2;}
._bottom{-webkit-transform:translate3D(0, 100%, 0);z-index:2;}




/* color */
.mWrap{background:#ccc;}
.gHeader,.gFooter{background:#B00;}
.oHeader,.oFooter{background:#2BB;}


</style>


</head>
<body>

<div class="gWrap">
	<div class="gHeader" style="height:36px;"><!-- 加载完毕添加高度值 -->
		<div class="header1" onclick="this.innerHTML += '<br>aaa'; this.parentNode.style.height = (this.parentNode.clientHeight + 18) + 'px';">全局固顶部分1</div>
		<div class="header2" onclick="this.innerHTML += '<br>bbb'; this.parentNode.style.height = (this.parentNode.clientHeight + 18) + 'px';">全局固顶部分2</div>
	</div>
	<div class="oWrap"><!--  -->
		<div class="box _current">
			<div class="oHeader" style="height:36px;">
				<div class="header1">TO: <a href="#" onclick="roolLeft(this);">LEFT</a> <a href="#" onclick="roolRight(this);">RIGHT</a> SEE: <a href="#" onclick="seeTop(this);">TOP</a> <a href="#" onclick="seeBottom(this);">BOTTOM</a> HIDE: <a href="#" onclick="hideTop(this);">TOP</a> <a href="#" onclick="hideBottom(this);">BOTTOM</a></div>
				<div class="header2" onclick="this.innerHTML += '<br>aaa'; this.parentNode.style.height = (this.parentNode.clientHeight + 18) + 'px';">当前box固顶部分2</div>
			</div>
			<div class="mWrap" id="wrapper"><!-- iScroll 应用区域，高度可控 -->
				<div class="iWrap" id="scroller"><!-- iScroll 滚动区域，为绝对定位 -->
					<div id="pullDown">
						<i class="pullDownIcon"></i><span class="pullDownLabel">Pull down to refresh...</span>
					</div>
					<ul id="thelist">
						<li>
							滚<br>动<br>内<br>容<br>滚<br>动<br>内<br>容<br>滚<br>动<br>内<br>容<br>
							滚<br>动<br>内<br>容<br>滚<br>动<br>内<br>容<br>滚<br>动<br>内<br>容<br>
							滚<br>动<br>内<br>容<br>滚<br>动<br>内<br>容<br>滚<br>动<br>内<br>容<br>
							滚<br>动<br>内<br>容<br>滚<br>动<br>内<br>容<br>滚<br>动<br>内<br>容<br>
						</li>
					</ul>
					<div id="pullUp">
						<i class="pullUpIcon"></i><span class="pullUpLabel">Pull up to refresh...</span>
					</div>
				</div>
				<!-- iScrollBar，js运行后会自动生成于此-->
			</div>
			<div class="oFooter" style="height:36px;">
				<div class="footer1" onclick="this.innerHTML += '<br>aaa'; this.parentNode.style.height = (this.parentNode.clientHeight + 18) + 'px';">当前box固底部分1</div>
				<div class="footer2" onclick="this.innerHTML += '<br>bbb'; this.parentNode.style.height = (this.parentNode.clientHeight + 18) + 'px';">当前box固底部分2</div>
			</div>
		</div>
		<div class="box">
			<div class="oHeader">
				<div>TO: <a href="#" onclick="roolLeft(this);">LEFT</a> <a href="#" onclick="roolRight(this);">RIGHT</a> SEE: <a href="#" onclick="seeTop(this);">TOP</a> <a href="#" onclick="seeBottom(this);">BOTTOM</a> HIDE: <a href="#" onclick="hideTop(this);">TOP</a> <a href="#" onclick="hideBottom(this);">BOTTOM</a></div>
			</div>
			<div class="mWrap" id="wrapper"><!-- iScroll 应用区域，高度可控 -->
				<div class="iWrap">another box</div>
			</div>
		</div>
			
	</div>
	<div class="gFooter" style="height:36px;">
		<div class="footer1" onclick="this.innerHTML += '<br>aaa'; this.parentNode.style.height = (this.parentNode.clientHeight + 18) + 'px';">全局固底部分1</div>
		<div class="footer2" onclick="this.innerHTML += '<br>bbb'; this.parentNode.style.height = (this.parentNode.clientHeight + 18) + 'px';">全局固底部分2</div>
	</div>
</div>

</body>
</html>
